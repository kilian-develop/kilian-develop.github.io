---
layout: post
title: ë„ë©”ì¸ ì¤‘ì‹¬ ì„¤ê³„ë¡œ ì¸í”„ë¼ì— ë…ë¦½ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„¤ê³„
date: 2025-10-19
categories: architecture
tags:
  - architecture
  - domain-driven-design
  - layered-architecture
  - multimodule
excerpt: ë„ë©”ì¸ ì¤‘ì‹¬ ì„¤ê³„ë¥¼ í†µí•´ ì¸í”„ë¼ ë³€ê²½ì— ì˜í–¥ë°›ì§€ ì•ŠëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë§Œë“œëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
image_thumbnail: /assets/images/posts/DDD.png
---
# í•˜ìœ„ ë ˆì´ì–´ì— ì˜ì¡´ì ì¸ ì•„í‚¤í…ì²˜
---
ì•„ë˜ ì´ë¯¸ì§€ëŠ” ì„œë¹„ìŠ¤ë¥¼ ê°œë°œí•˜ë‹¤ ë³´ë©´ í”íˆë“¤ ë³¼ ìˆ˜ ìˆëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì•„í‚¤í…ì²˜ì˜ êµ¬ì¡°ì…ë‹ˆë‹¤.

![ë ˆì´ì–´ë“œ ì•„í‚¤í…ì³](/assets/images/posts/ë ˆì´ì–´ë“œ%20ì•„í‚¤í…ì³.png)
ë§ì€ ë¸”ë¡œê·¸ì˜ í¬ìŠ¤íŠ¸ë“¤ì´ë‚˜ ë¬¸ì„œë“¤ì´ ì•„ë˜ì™€ ê°™ì´ ì„¤ëª…í•˜ê³  ìˆìŠµë‹ˆë‹¤.

**ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ë€?**
- ì†Œí”„íŠ¸ì›¨ì–´ë¥¼Â **ì—¬ëŸ¬ ê°œì˜ ê³„ì¸µìœ¼ë¡œ ë¶„ë¦¬í•´ì„œ ì„¤ê³„**í•˜ëŠ” ë°©ë²•
- ê°ê° ê³„ì¸µì´Â ì„œë¡œÂ **ë…ë¦½ì ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆì–´ì„œ**Â í•œ ê³„ì¸µì˜ ë³€ê²½ì´ ë‹¤ë¥¸ ê³„ì¸µì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê²Œ ì„¤ê³„í•  ìˆ˜ ìˆë‹¤.
- ì™¸ë¶€ì˜ ìš”êµ¬ì‚¬í•­ì´ë‚˜ ì„¸ë¶€ì ì¸ **êµ¬í˜„ì´ ë³€í™”í•˜ë”ë¼ë„ ë„ë©”ì¸ì˜ ë¡œì§ì„ ë³€ê²½í•˜ì§€ ì•Šë„ë¡ ë³´í˜¸**í•˜ê¸° ìœ„í•´ì„œ ê³„ì¸µí™”ë¥¼ í•˜ê²Œ ëœë‹¤.

í•˜ì§€ë§Œ ìš°ë¦¬ê°€ ê°œë°œí•˜ëŠ” ëŒ€ë¶€ë¶„ì˜ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.
```java
  @Entity
  @Getter
  @Setter
  public class Order {
      @Id
      @GeneratedValue(strategy = GenerationType.IDENTITY)
      private Long id;

      private String orderNumber;
      private BigDecimal totalAmount;
      private LocalDateTime createdAt;

      public Order(String orderNumber, BigDecimal totalAmount) {
          this.orderNumber = orderNumber;
          this.totalAmount = totalAmount;
          this.createdAt = LocalDateTime.now();
      }

      public Order() {}
  }
```

```java
  @Repository
  public interface OrderRepository extends JpaRepository<Order, Long> {
  }
```

```java
  @Service
  @RequiredArgsConstructor
  public class OrderService {
      private final OrderRepository orderRepository;

      public OrderResponse createOrder(String orderNumber, BigDecimal totalAmount) {
          Order order = new Order(orderNumber, totalAmount);
          Order savedOrder = orderRepository.save(order);
          return new OrderResponse(savedOrder);
      }
  }
```

``` java
  @RestController
  @RequestMapping("/api/orders")
  @RequiredArgsConstructor
  public class OrderController {
      private final OrderService orderService;

      @PostMapping
      public OrderResponse createOrder(@RequestParam String orderNumber,
                                       @RequestParam BigDecimal totalAmount) {
          return orderService.createOrder(orderNumber, totalAmount);
      }
  }
```

## ì§„ì§œ ë¬¸ì œëŠ” "ì˜ì¡´ì„±"
---
ìœ„ ì½”ë“œë¥¼ ë³´ì‹œë©´ **ì—¬ëŸ¬ ê³„ì¸µìœ¼ë¡œ ë¶„ë¦¬**ë˜ì–´ ìˆê³ , **ê°ê°ì´ ë…ë¦½ì **ì´ë©°, **êµ¬í˜„ì´ ë³€í•´ë„ ë„ë©”ì¸ì€ ì•ˆì „**í•´ ë³´ì…ë‹ˆë‹¤.

í•˜ì§€ë§Œ ì—¬ê¸°ì— í•¨ì •ì´ ìˆ¨ì–´ìˆìŠµë‹ˆë‹¤. ì œê°€ ì½”ë“œë¥¼ ë¶„ì„í•˜ë‹¤ê°€ ë°œê²¬í•œ ë¬¸ì œê°€ ì„¸ ê°€ì§€ ìˆì—ˆìŠµë‹ˆë‹¤:

1. **ServiceLayerê°€ JPA ì—”í‹°í‹°ì— ì˜ì¡´** - OrderëŠ” ì´ë¯¸ JPA ì• ë…¸í…Œì´ì…˜ê³¼ ê°•í•˜ê²Œ ê²°í•©ë¨
2. **ServiceLayerê°€ DTOì— ì˜ì¡´** - OrderResponseëŠ” REST API ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ê°•í•˜ê²Œ ê²°í•©ë¨
3. **ServiceLayerê°€ êµ¬í˜„ì²´ì— ì˜ì¡´** - JpaRepositoryë¥¼ ìƒì†í•œ OrderRepositoryì—ë§Œ ì‘ë™í•¨

ë¬¸ì œëŠ” ë‹¨ìˆœíˆ "ê³„ì¸µì„ ë¶„ë¦¬í–ˆë‹¤"ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í–ˆìŠµë‹ˆë‹¤. **"ëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ ì˜ì¡´í•˜ê³  ìˆëŠ”ê°€"**ê°€ í›¨ì”¬ ë” ì¤‘ìš”í•©ë‹ˆë‹¤.

## ë¬¸ì œ 1: ë°ì´í„°ë² ì´ìŠ¤ê°€ ë°”ë€Œë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë„ ê¹¨ì§„ë‹¤
---
ì œê°€ ì²˜ìŒ ë§ˆì£¼ì¹œ ì§ˆë¬¸ì€ ì´ê±°ì˜€ìŠµë‹ˆë‹¤:

> [!info]
> **ë°ì´í„°ë² ì´ìŠ¤ë¥¼ MongoDBë¡œ ë°”ê¾¼ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œ?**

OrderëŠ” JPA ì—”í‹°í‹°ì…ë‹ˆë‹¤. `@Entity`, `@Table`, `@Id` ê°™ì€ ì• ë…¸í…Œì´ì…˜ë“¤ì´ ê°€ë“í•©ë‹ˆë‹¤. ì´ê±´ **RDBì— ë§¤ìš° ê°•í•˜ê²Œ ê²°í•©**ëœ ì„¤ê³„ì…ë‹ˆë‹¤.

MongoDBë¡œ ì „í™˜í•œë‹¤ë©´?

JPA ì• ë…¸í…Œì´ì…˜ë“¤ì„ ëª¨ë‘ ì œê±°í•˜ê³  Spring Data MongoDBì˜ ì• ë…¸í…Œì´ì…˜ìœ¼ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤. **ì—”í‹°í‹° êµ¬ì¡° ìì²´ë¥¼ ì¬ì„¤ê³„**í•´ì•¼ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ ë°œê²¬í•œ ë” í° ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. Order ì—”í‹°í‹°ì—ëŠ” ë‹¨ìˆœí•œ ë°ì´í„°ë§Œ ì•„ë‹ˆë¼ **ì£¼ë¬¸ ìƒì„± ë¡œì§, ê¸ˆì•¡ ê³„ì‚° ë¡œì§ ê°™ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë“¤ì´ ì„ì—¬**ìˆì—ˆìŠµë‹ˆë‹¤.

ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ë‹¤ ë³´ë‹ˆ ì‹¤ìˆ˜ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë„ í•¨ê»˜ ë³€ê²½ë  ìˆ˜ë°–ì— ì—†ì—ˆìŠµë‹ˆë‹¤. ì´ê²Œ ë¬¸ì œì˜€ìŠµë‹ˆë‹¤.

## ë¬¸ì œ 2: ì¸í„°í˜ì´ìŠ¤ê°€ ë³€í•˜ë©´ ì„œë¹„ìŠ¤ë„ í•¨ê»˜ ë³€í•œë‹¤
---
ë˜ ë‹¤ë¥¸ ìƒí™©ì„ ìƒê°í•´ë´¤ìŠµë‹ˆë‹¤:

> [!info]
> **REST API ëŒ€ì‹  Kafka ë©”ì‹œì§€ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤ë©´?**

OrderServiceëŠ” `OrderResponse` DTOë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ DTOëŠ” **REST API ì‘ë‹µ í˜•ì‹ì— ë§ì¶° ì„¤ê³„**ëœ ê²ƒì…ë‹ˆë‹¤. OrderControllerë¥¼ í†µí•´ JSONìœ¼ë¡œ ì§ë ¬í™”ë˜ëŠ” ê²ƒì„ ì „ì œë¡œ ë§Œë“¤ì–´ì§„ ê²ƒì´ì£ .

ë§Œì•½ ë™ì¼í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ Kafka ë©”ì‹œì§€ ê¸°ë°˜ìœ¼ë¡œ ë…¸ì¶œí•´ì•¼ í•œë‹¤ë©´?

ServiceëŠ” ë” ì´ìƒ OrderResponseë¥¼ ë°˜í™˜í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ OrderEvent ê°™ì€ ê°ì²´ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤. **Serviceê°€ í†µì‹  ë°©ì‹ì˜ ë³€ê²½ì— ì˜í–¥ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.**

## ê·¼ë³¸ ì›ì¸: "ê³„ì¸µì˜ ë¶„ë¦¬"ê°€ ì•„ë‹ˆë¼ "ì˜ì¡´ì„±ì˜ ë°©í–¥"

ì´ ë‘ ê°€ì§€ ë¬¸ì œë¥¼ ë¶„ì„í•˜ë‹¤ ë³´ë‹ˆ íŒ¨í„´ì´ ë³´ì˜€ìŠµë‹ˆë‹¤:

**ìƒìœ„ ê³„ì¸µ(Service)ì´ í•˜ìœ„ ê³„ì¸µ(Persistence, Presentation)ì— ì˜ì¡´í•˜ê³  ìˆë‹¤**ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

ê¹¨ë‹¬ì€ ê²Œ ìˆì—ˆìŠµë‹ˆë‹¤. ê³„ì¸µì„ ë¶„ë¦¬í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•©ë‹ˆë‹¤. **ì˜ì¡´ì„±ì˜ ë°©í–¥ì„ ë’¤ì§‘ì–´ì•¼ í•©ë‹ˆë‹¤.**

# í•´ê²°ì±…: ì˜ì¡´ì„±ì„ ì—­ì „ì‹œí‚¤ì
---
ë¬¸ì œì˜ í•µì‹¬ì€ ëª…í™•í–ˆìŠµë‹ˆë‹¤:

> [!info]
> **í•˜ìœ„ ê³„ì¸µ(Infrastructure)ì´ Serviceë¥¼ ì§€ë°°í•˜ì§€ ë§ê³ ,**
> **Serviceê°€ ìì‹ ì´ í•„ìš”ë¡œ í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•˜ë„ë¡ í•´ì•¼ í•œë‹¤.**

ì´ë¥¼ ìœ„í•´ ì €ëŠ” **JPA ì—”í‹°í‹°ì™€ ë„ë©”ì¸ ê°ì²´ë¥¼ ì™„ì „íˆ ë¶„ë¦¬**í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

ì£¼ìš” ê°œì„  ì‚¬í•­ì€:

1. **ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ìœ¼ë¡œë¶€í„° ììœ ë¡œì›Œì§„ë‹¤**
   - MongoDBë¡œ ë³€ê²½ë˜ì–´ë„ ë„ë©”ì¸ê³¼ ServiceëŠ” ê±´ë“œë¦´ í•„ìš”ê°€ ì—†ìŒ
   - Infrastructure ê³„ì¸µë§Œ êµì²´í•˜ë©´ ë¨

2. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ìœ¼ë¡œ ì„¤ê³„ëœë‹¤**
   - ë°ì´í„° êµ¬ì¡°ì— ë§ì¶œ í•„ìš”ê°€ ì—†ìŒ
   - ì—­í• ê³¼ ì±…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„ ê°€ëŠ¥
   - ê°ì²´ì§€í–¥ ì›ì¹™(ë‹¤í˜•ì„±, ì¶”ìƒí™”)ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì ìš©í•  ìˆ˜ ìˆìŒ

3. **ë„ë©”ì¸ì´ ì§„ì •í•œ ë¶ˆë³€ ê°ì²´ê°€ ë  ìˆ˜ ìˆë‹¤**
   - `final` í‚¤ì›Œë“œ ì‚¬ìš© ê°€ëŠ¥
   - CQS ì›ì¹™ì„ ëª…í™•í•˜ê²Œ ë”°ë¥¼ ìˆ˜ ìˆìŒ
   - ë¶€ìˆ˜íš¨ê³¼(side effect) ì œê±°

## 1ë‹¨ê³„: ë„ë©”ì¸ê³¼ ì¸í”„ë¼ë¥¼ ë¶„ë¦¬
---
### Before: ë‹¨ìˆœí•œ ë¶„ë¦¬ ì‹œë„

ì²˜ìŒì— ë§ì€ ê°œë°œìë“¤ì´ ì‹œë„í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤:

```java
@Entity
@Getter
@Setter
public class Order {  // JPAì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì„ì—¬ìˆìŒ
    @Id
    private Long id;
    private String orderNumber;
    private BigDecimal totalAmount;
}

@Service
public class OrderService {
    private final OrderRepository orderRepository;

    public Order createOrder(String orderNumber, BigDecimal totalAmount) {
        Order order = new Order(orderNumber, totalAmount);
        return orderRepository.save(order);
    }
}
```

ë¬¸ì œëŠ” ë¶„ëª…í•©ë‹ˆë‹¤. **ë°ì´í„°ë² ì´ìŠ¤ê°€ MariaDBì—ì„œ MongoDBë¡œ ë°”ë€ŒëŠ” ìˆœê°„, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë„ í•¨ê»˜ ë³€í•´ì•¼ í•©ë‹ˆë‹¤.**

ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•Œ ì‹¤ìˆ˜ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê±´ë“œë¦´ ìœ„í—˜ì´ ë„ˆë¬´ ë†’ìŠµë‹ˆë‹¤.

### After: ê³„ì¸µì„ ëª…í™•í•˜ê²Œ ë¶„ë¦¬

ë‹¤ë¥¸ ë°©ì‹ì„ ì‹œë„í–ˆìŠµë‹ˆë‹¤. **ë„ë©”ì¸ì€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë§Œ, JPAëŠ” ë°ì´í„° ë§¤í•‘ë§Œ ë‹´ë‹¹**í•˜ë„ë¡ ë§ì…ë‹ˆë‹¤.

ë¨¼ì € ë„ë©”ì¸ ê°ì²´ì…ë‹ˆë‹¤:

```java
public class Order {
    private final Long id;
    private final String orderNumber;
    private final BigDecimal totalAmount;
    private final LocalDateTime createdAt;

    public Order(String orderNumber, BigDecimal totalAmount) {
        this.orderNumber = orderNumber;
        this.totalAmount = totalAmount;
        this.createdAt = LocalDateTime.now();
    }

    public String getOrderNumber() { return orderNumber; }
    public BigDecimal getTotalAmount() { return totalAmount; }
    public LocalDateTime getCreatedAt() { return createdAt; }
}
```

JPA ì—”í‹°í‹°ëŠ” ìˆœìˆ˜í•˜ê²Œ ORM ë§¤í•‘ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤:

```java
@Entity
@Getter
@Setter
public class OrderEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String orderNumber;
    private BigDecimal totalAmount;
    private LocalDateTime createdAt;
}
```

ë¦¬í¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•˜ì—¬ ë„ë©”ì¸ì— ì˜ì¡´í•˜ë„ë¡ í•©ë‹ˆë‹¤:

```java
public interface OrderRepository {
    Order save(Order order);
    Order findById(Long id);
}
```

JPA êµ¬í˜„ì²´ëŠ” ë„ë©”ì¸ê³¼ JPA ì—”í‹°í‹° ì‚¬ì´ì˜ ë§¤í•‘ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤:

```java
@Repository
public class OrderRepositoryImpl implements OrderRepository {
    private final OrderJpaRepository jpaRepository;

    @Override
    public Order save(Order order) {
        OrderEntity entity = new OrderEntity();
        entity.setOrderNumber(order.getOrderNumber());
        entity.setTotalAmount(order.getTotalAmount());
        entity.setCreatedAt(order.getCreatedAt());

        OrderEntity saved = jpaRepository.save(entity);
        return new Order(saved.getOrderNumber(), saved.getTotalAmount());
    }

    @Override
    public Order findById(Long id) {
        return jpaRepository.findById(id)
            .map(entity -> new Order(entity.getOrderNumber(), entity.getTotalAmount()))
            .orElseThrow();
    }
}

@Repository
public interface OrderJpaRepository extends JpaRepository<OrderEntity, Long> {
}
```

ì„œë¹„ìŠ¤ ë ˆì´ì–´ëŠ” ë„ë©”ì¸ ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´í•©ë‹ˆë‹¤:

```java
@Service
public class OrderService {
    private final OrderRepository orderRepository;

    public Order createOrder(String orderNumber, BigDecimal totalAmount) {
        Order order = new Order(orderNumber, totalAmount);
        return orderRepository.save(order);
    }
}
```

ì´ì œ ì •ë§ë¡œ ê°•ë ¥í•œ ë¶€ë¶„ì´ ë³´ì…ë‹ˆë‹¤. **MongoDBë¡œ ë³€ê²½í•´ì•¼ í•œë‹¤ë©´?**

```java
@Repository
public class OrderMongoRepository implements OrderRepository {
    private final OrderMongoDao mongoDao;

    @Override
    public Order save(Order order) {
        OrderDocument doc = new OrderDocument();
        doc.setOrderNumber(order.getOrderNumber());
        doc.setTotalAmount(order.getTotalAmount());
        mongoDao.save(doc);
        return order;
    }

    @Override
    public Order findById(Long id) {
        return mongoDao.findById(id)
            .map(doc -> new Order(doc.getOrderNumber(), doc.getTotalAmount()))
            .orElseThrow();
    }
}
```

**ê²°ê³¼ëŠ” ì´ë ‡ìŠµë‹ˆë‹¤:**
- **OrderServiceëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ** âœ“
- **ë„ë©”ì¸ Orderë„ ë³€ê²½í•˜ì§€ ì•ŠìŒ** âœ“
- **êµ¬í˜„ì²´ë§Œ MongoDB ë²„ì „ìœ¼ë¡œ êµì²´** âœ“

ì´ê²ƒì´ ë°”ë¡œ ì˜ì¡´ì„±ì„ ì—­ì „ì‹œí‚¨ íš¨ê³¼ì…ë‹ˆë‹¤. Serviceê°€ êµ¬í˜„ì²´ì— ì˜ì¡´í•˜ì§€ ì•Šê³ , ìì‹ ì´ í•„ìš”í•œ ì¸í„°í˜ì´ìŠ¤ë§Œ ì•Œê³  ìˆì„ ë¿ì…ë‹ˆë‹¤.

## 2ë‹¨ê³„: ì—­í• ê³¼ ì±…ì„ìœ¼ë¡œ ì„¤ê³„
---
### ë°ì´í„° ì¤‘ì‹¬ vs ì±…ì„ ì¤‘ì‹¬ì˜ ì°¨ì´

**JPA ì—”í‹°í‹°ëŠ” ë°ì´í„° ì¤‘ì‹¬ì¼ ìˆ˜ë°–ì— ì—†ìŠµë‹ˆë‹¤.** RDBì˜ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ë°˜ì˜í•˜ë‹ˆê¹Œìš”.

í•˜ì§€ë§Œ **ë„ë©”ì¸ ê°ì²´ëŠ” ì—­í• ê³¼ ì±…ì„ìœ¼ë¡œ ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.** ë°ì´í„° êµ¬ì¡°ì— ì–½ë§¤ì¼ í•„ìš”ê°€ ì—†ê±°ë“ ìš”.

ì‹¤ì œ ì˜ˆì‹œë¡œ ë¹„êµí•´ë´…ì‹œë‹¤. í• ì¸ ì •ì±…ì´ ì—¬ëŸ¬ ì¢…ë¥˜ê°€ ìˆë‹¤ê³  ê°€ì •í•´ë´…ì‹œë‹¤.

### Before: ë°ì´í„° ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„í•˜ë©´

```java
@Entity
@Getter
public class DiscountPolicy {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private Long orderId;

    // ì •ì•¡í• ì¸ í•„ë“œ
    private BigDecimal fixedDiscountAmount;

    // ì •ë¥ í• ì¸ í•„ë“œ
    private BigDecimal percentageDiscount;

    // ì¿ í°í• ì¸ í•„ë“œ
    private String couponCode;
    private boolean isCouponExpired;
    private BigDecimal couponDiscountAmount;

    // í• ì¸ íƒ€ì… êµ¬ë¶„
    private String discountType;  // "FIXED", "PERCENTAGE", "COUPON"

    private LocalDateTime createdAt;
}
```

ì´ ë°©ì‹ì˜ ë¬¸ì œëŠ” ëª…í™•í•©ë‹ˆë‹¤:

- ì •ì•¡í• ì¸, ì •ë¥ í• ì¸, ì¿ í°í• ì¸... ëª¨ë“  ë°©ì‹ì˜ í•„ë“œë¥¼ **í•œ ì—”í‹°í‹°ì— ë•Œë ¤ ë°•ì•„ì•¼ í•¨**
- ì‹¤ì œë¡œ í•„ìš” ì—†ëŠ” í•„ë“œë“¤ë„ **nullë¡œ ì±„ì›Œì§** (ë°ì´í„° ë‚­ë¹„)
- ìƒˆë¡œìš´ í• ì¸ ì •ì±…ì´ ë‚˜ì˜¬ ë•Œë§ˆë‹¤ **ì—”í‹°í‹°ì— ìƒˆ í•„ë“œë¥¼ ì¶”ê°€**í•´ì•¼ í•¨
- ê°ì²´ì§€í–¥ì˜ ë‹¤í˜•ì„±, ì¶”ìƒí™”ë¥¼ í™œìš©í•  ìˆ˜ ì—†ìŒ

ì´ë ‡ê²Œ ë˜ë©´ ì½”ë“œê°€ ì ì  ë³µì¡í•´ì§‘ë‹ˆë‹¤.

### After: ì±…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„í•˜ë©´

**ë„ë©”ì¸ìœ¼ë¡œ êµ¬ì„±í•œë‹¤ë©´, ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°ì— ìƒê´€ì—†ì´ ë¹„ì¦ˆë‹ˆìŠ¤ ì±…ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ê³„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

ë¨¼ì € í• ì¸ì˜ ì±…ì„ì„ ì¸í„°í˜ì´ìŠ¤ë¡œ ì •ì˜í•©ë‹ˆë‹¤:

```java
public interface DiscountPolicy {
    boolean isValid();
    BigDecimal calculateDiscount(BigDecimal originalAmount);
}
```

ëª¨ë“  êµ¬í˜„ì²´ê°€ OrderIdë¥¼ ë™ì¼í•˜ê²Œ ê´€ë¦¬í•˜ë¯€ë¡œ, ê³µí†µ ë¡œì§ì„ ì¶”ìƒí´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤:

```java
// OrderIdë¥¼ ê³µí†µìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì¶”ìƒí´ë˜ìŠ¤
public abstract class AbstractDiscountPolicy implements DiscountPolicy {
    protected final Long orderId;

    public AbstractDiscountPolicy(Long orderId) {
        this.orderId = orderId;
    }

    @Override
    public final Long getOrderId() {
        return orderId;
    }
}

public class FixedAmountDiscount extends AbstractDiscountPolicy {
    private final BigDecimal discountAmount;

    public FixedAmountDiscount(Long orderId, BigDecimal discountAmount) {
        super(orderId);
        this.discountAmount = discountAmount;
    }

    @Override
    public boolean isValid() {
        return discountAmount != null && discountAmount.compareTo(BigDecimal.ZERO) > 0;
    }

    @Override
    public BigDecimal calculateDiscount(BigDecimal originalAmount) {
        if (!isValid()) {
            throw new InvalidDiscountException("ì •ì•¡í• ì¸ ê¸ˆì•¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        }
        return discountAmount.min(originalAmount);
    }
}

public class PercentageDiscount extends AbstractDiscountPolicy {
    private final BigDecimal percentage;

    public PercentageDiscount(Long orderId, BigDecimal percentage) {
        super(orderId);
        this.percentage = percentage;
    }

    @Override
    public boolean isValid() {
        return percentage != null
            && percentage.compareTo(BigDecimal.ZERO) > 0
            && percentage.compareTo(BigDecimal.valueOf(100)) < 0;
    }

    @Override
    public BigDecimal calculateDiscount(BigDecimal originalAmount) {
        if (!isValid()) {
            throw new InvalidDiscountException("í• ì¸ìœ¨ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        }
        return originalAmount.multiply(percentage).divide(BigDecimal.valueOf(100));
    }
}

public class CouponDiscount extends AbstractDiscountPolicy {
    private final String couponCode;
    private final BigDecimal discountAmount;
    private final boolean isExpired;

    public CouponDiscount(Long orderId, String couponCode, BigDecimal discountAmount, boolean isExpired) {
        super(orderId);
        this.couponCode = couponCode;
        this.discountAmount = discountAmount;
        this.isExpired = isExpired;
    }

    @Override
    public boolean isValid() {
        return !isExpired && discountAmount.compareTo(BigDecimal.ZERO) > 0;
    }

    @Override
    public BigDecimal calculateDiscount(BigDecimal originalAmount) {
        if (!isValid()) {
            throw new InvalidDiscountException("ì¿ í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤");
        }
        return discountAmount.min(originalAmount);
    }
}
```

ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œëŠ” DiscountPolicy ëª©ë¡ì„ í†µí•´ ì´ í• ì¸ì•¡ì„ ê³„ì‚°í•©ë‹ˆë‹¤:

```java
@Service
public class OrderService {
    private final OrderRepository orderRepository;
    private final DiscountPolicyRepository discountPolicyRepository;

    public Order createOrder(String orderNumber, BigDecimal amount) {
        return orderRepository.save(new Order(UUID.randomUUID(), orderNumber, amount));
    }

    public BigDecimal getOrderTotal(Long orderId) {
        Order order = orderRepository.findById(orderId);
        List<DiscountPolicy> discountPolicies = discountPolicyRepository.findByOrderId(orderId);

        BigDecimal totalDiscount = BigDecimal.ZERO;
        for (DiscountPolicy policy : discountPolicies) {
            if (policy.isValid()) {
                totalDiscount = totalDiscount.add(policy.calculateDiscount(order.getOriginalAmount()));
            }
        }

        return order.calculateFinalAmount(totalDiscount);
    }
}
```

ì´ë ‡ê²Œ ì„¤ê³„í•˜ë©´:
- **ì •ì•¡í• ì¸**: ê¸ˆì•¡ í•„ë“œë§Œ í•„ìš”
- **ì •ë¥ í• ì¸**: ë¹„ìœ¨ í•„ë“œë§Œ í•„ìš”
- **ì¿ í°í• ì¸**: ì¿ í°ì½”ë“œ, ë§Œë£Œ ì—¬ë¶€ë§Œ í•„ìš”

ê°ê° í•„ìš”í•œ ê²ƒë§Œ ê°€ì§€ê³ , **ê·¸ ì—­í• ì—ë§Œ ì¶©ì‹¤í•©ë‹ˆë‹¤.** ìƒˆë¡œìš´ í• ì¸ ì •ì±…ë„ ì‰½ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ë¹„êµ í‘œë¡œ ë³´ëŠ” ì°¨ì´

| ì¸¡ë©´          | Before (ë°ì´í„° ì¤‘ì‹¬)   | After (ì±…ì„ ì¤‘ì‹¬)        |
| ----------- | ----------------- | -------------------- |
| **í•„ë“œ**      | ëª¨ë“  í• ì¸ ë°©ì‹ í•„ë“œ í¬í•¨    | ê° ì •ì±…ë³„ í•„ìš”í•œ í•„ë“œë§Œ        |
| **Null ì²˜ë¦¬** | ë¯¸ì‚¬ìš© í•„ë“œëŠ” nullë¡œ ì±„ì›€  | í•­ìƒ ì˜ë¯¸ ìˆëŠ” ê°’ë§Œ          |
| **í™•ì¥ì„±**     | ì •ì±… ì¶”ê°€ ì‹œ ì—”í‹°í‹° ìˆ˜ì • í•„ìš” | ìƒˆ í´ë˜ìŠ¤ë§Œ ì¶”ê°€ (ê°œë°©-íì‡„ ì›ì¹™) |
| **í…ŒìŠ¤íŠ¸**     | ë§ì€ í•„ë“œë¥¼ ì„¸íŒ…í•´ì•¼ í•¨     | í•„ìš”í•œ ê²ƒë§Œ ê°„ë‹¨íˆ ì„¸íŒ…        |

ì—¬ê¸°ì„œ ì¬ë¯¸ìˆëŠ” ì ì€ **ì‹¤ì œ DBì—ëŠ” ëª¨ë“  ë°ì´í„°ê°€ í•œ í…Œì´ë¸”ì— ìˆì–´ë„ ê´œì°®ë‹¤**ëŠ” ê²ƒì…ë‹ˆë‹¤. ë§¤í•‘ ê³„ì¸µì´ ì´ë¥¼ ì²˜ë¦¬í•˜ë‹ˆê¹Œìš”.


### ì˜ì†ì„± ê³„ì¸µì—ì„œì˜ ë§¤í•‘ ì²˜ë¦¬

ì—¬ê¸°ì„œ í•µì‹¬ì€ **ì‹¤ì œ DB êµ¬ì¡°ì™€ ë„ë©”ì¸ êµ¬ì¡°ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤**ëŠ” ê²ƒì…ë‹ˆë‹¤.

DBì—ëŠ” ëª¨ë“  í• ì¸ ì •ë³´ê°€ í•œ í…Œì´ë¸”ì—:

```java
@Entity
@Table(name = "discount_policies")
public class DiscountPolicyEntity {
    @Id
    private Long id;
    private String policyType;  // FIXED, PERCENTAGE, COUPON
    private BigDecimal amount;
    private String couponCode;
    private boolean isExpired;
}
```

```java
@Entity
@Table(name = "discount_policies")
public class DiscountPolicyEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String policyType;  // FIXED, PERCENTAGE, COUPON
    private BigDecimal amount;
    private String couponCode;
    private boolean isExpired;
}
```

Repository ì¸í„°í˜ì´ìŠ¤ëŠ” **ë„ë©”ì¸ ê´€ì **ì—ì„œ ì •ì˜í•©ë‹ˆë‹¤:

```java
public interface DiscountPolicyRepository {
    List<DiscountPolicy> findByOrderId(Long orderId);
}
```

ê·¸ë¦¬ê³  Repository êµ¬í˜„ì²´ê°€ **ë§¤í•‘ì˜ ì±…ì„**ì„ ì§‘ë‹ˆë‹¤:

```java
@Repository
public class DiscountPolicyRepositoryImpl implements DiscountPolicyRepository {
    private final DiscountPolicyJpaRepository jpaRepository;

    @Override
    public List<DiscountPolicy> findByOrderId(Long orderId) {
        List<DiscountPolicyEntity> entities = jpaRepository.findByOrderId(orderId);

        // Entityë¥¼ ë„ë©”ì¸ êµ¬í˜„ì²´ë¡œ ë³€í™˜
        return entities.stream()
            .map(this::buildDiscountPolicy)
            .collect(Collectors.toList());
    }

    private DiscountPolicy buildDiscountPolicy(DiscountPolicyEntity entity) {
        return switch(entity.getPolicyType()) {
            case "FIXED" -> new FixedAmountDiscount(entity.getOrderId(), entity.getAmount());
            case "PERCENTAGE" -> new PercentageDiscount(entity.getOrderId(), entity.getPercentage());
            case "COUPON" -> new CouponDiscount(entity.getOrderId(), entity.getCouponCode(),
                                                 entity.getAmount(), entity.isExpired());
            default -> throw new IllegalArgumentException("Unknown policy type");
        };
    }
}
```

### ë°ì´í„°ë² ì´ìŠ¤ê°€ ë³€ê²½ë˜ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

ë‚˜ì¤‘ì— ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ í• ì¸ ì •ì±…ì„ **íƒ€ì…ë³„ë¡œ ë¶„ë¦¬ëœ í…Œì´ë¸”**ë¡œ ë³€ê²½í•œë‹¤ê³  í•´ë´…ì‹œë‹¤:

```java
@Entity @Table(name = "fixed_discount_policies")
public class FixedDiscountPolicyEntity { /* ... */ }

@Entity @Table(name = "percentage_discount_policies")
public class PercentageDiscountPolicyEntity { /* ... */ }

@Entity @Table(name = "coupon_discount_policies")
public class CouponDiscountPolicyEntity { /* ... */ }
```

**ê·¸ëŸ¼ ServiceëŠ” ì–´ë–»ê²Œ ë ê¹Œìš”?**

**ì•„ë¬´ê²ƒë„ ì•ˆ í•©ë‹ˆë‹¤.** ğŸ˜€

Serviceê°€ ì•Œì•„ì•¼ í•  ê²ƒì€ `DiscountPolicyRepository.findByOrderId()` ë¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¿ì…ë‹ˆë‹¤. êµ¬í˜„ì´ ì–´ë–»ê²Œ ë³€í–ˆëŠ”ì§€ ëª¨ë¦…ë‹ˆë‹¤.

Repository êµ¬í˜„ì²´ì˜ `findByOrderId()` ë©”ì„œë“œë§Œ ìˆ˜ì •í•˜ë©´ ë:

```java
@Repository
public class DiscountPolicyRepositoryImpl implements DiscountPolicyRepository {
    private final FixedDiscountPolicyJpaRepository fixedRepo;
    private final PercentageDiscountPolicyJpaRepository percentageRepo;
    private final CouponDiscountPolicyJpaRepository couponRepo;

    @Override
    public List<DiscountPolicy> findByOrderId(Long orderId) {
        List<DiscountPolicy> policies = new ArrayList<>();

        // ê° í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
        fixedRepo.findByOrderId(orderId).stream()
            .map(entity -> new FixedAmountDiscount(orderId, entity.getAmount()))
            .forEach(policies::add);

        percentageRepo.findByOrderId(orderId).stream()
            .map(entity -> new PercentageDiscount(orderId, entity.getPercentage()))
            .forEach(policies::add);

        couponRepo.findByOrderId(orderId).stream()
            .map(entity -> new CouponDiscount(orderId, entity.getCouponCode(),
                                               entity.getAmount(), entity.isExpired()))
            .forEach(policies::add);

        return policies;
    }
}
```

**ë³€ê²½ ë²”ìœ„ë¥¼ ì •ë¦¬í•˜ë©´:**
- âœ… ë„ë©”ì¸ (Order, DiscountPolicy) - **ë³€ê²½ ì—†ìŒ**
- âœ… Service - **ë³€ê²½ ì—†ìŒ**
- âš ï¸ Repository êµ¬í˜„ì²´ - ìˆ˜ì • (ë§¤í•‘ ë¡œì§ë§Œ)
- ğŸ”§ DB ìŠ¤í‚¤ë§ˆ - ë³€ê²½ (í…Œì´ë¸” ë¶„ë¦¬)

## ë°ì´í„° ì¤‘ì‹¬ ì„¤ê³„ì˜ ë¬¸ì œì 
---
JPA ì—”í‹°í‹°ëŠ” RDBì— ê°•í•˜ê²Œ ê²°í•©ë˜ë¯€ë¡œ, ë°ì´í„° ì¤‘ì‹¬ ì„¤ê³„ê°€ ë©ë‹ˆë‹¤. ì´ë ‡ê²Œ ë˜ë©´:

```java
// JPA ì—”í‹°í‹° - ëª¨ë“  ë¡œì§ì´ í•œê³³ì—
public BigDecimal calculateFinalAmount() {
    if ("FIXED".equals(discountType)) {
        return totalAmount.subtract(fixedDiscountAmount);
    } else if ("PERCENTAGE".equals(discountType)) {
        return totalAmount.multiply(
            BigDecimal.ONE.subtract(percentageDiscount.divide(BigDecimal.valueOf(100)))
        );
    } else if ("COUPON".equals(discountType)) {
        if (isCouponExpired(couponCode)) return totalAmount;
        return totalAmount.subtract(fixedDiscountAmount);
    }
    return totalAmount;
}
```

ë¬¸ì œì :
- **ìƒˆë¡œìš´ ì •ì±…ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì´ ë©”ì„œë“œë¥¼ ìˆ˜ì •**í•´ì•¼ í•¨
- **OCP (ê°œë°©-íì‡„ ì›ì¹™) ìœ„ë°˜**
- **DB êµ¬ì¡°ê°€ ë°”ë€Œë©´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë„ í•¨ê»˜ ìˆ˜ì •**ë˜ëŠ” ìœ„í—˜

```java
// JPA ì—”í‹°í‹° - ë°ì´í„° ì¤‘ì‹¬
public BigDecimal calculateFinalAmount() {
    if ("FIXED".equals(discountType)) {
        return totalAmount.subtract(fixedDiscountAmount);
    } else if ("PERCENTAGE".equals(discountType)) {
        return totalAmount.multiply(BigDecimal.ONE.subtract(percentageDiscount.divide(BigDecimal.valueOf(100))));
    } else if ("COUPON".equals(discountType)) {
        // ì¿ í° ìœ íš¨ì„± í™•ì¸ ë¡œì§
        if (isCouponExpired(couponCode)) {
            return totalAmount;
        }
        return totalAmount.subtract(fixedDiscountAmount);
    }
    return totalAmount;
}
```

ì´ëŠ” ê°ì²´ì§€í–¥ ì›ì¹™ì„ ìœ„ë°˜í•˜ë©°, ìƒˆë¡œìš´ í• ì¸ ì •ì±…ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ì´ ë©”ì„œë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ **Open-Closed Principle(í™•ì¥ì—ëŠ” ì—´ë ¤ìˆê³  ìˆ˜ì •ì—ëŠ” ë‹«í˜€ìˆì–´ì•¼ í•œë‹¤)** ìœ„ë°˜ì´ë¼ê³  í•©ë‹ˆë‹¤.

ë˜í•œ, DiscountPolicyì˜ DB í…Œì´ë¸” êµ¬ì¡°ê°€ ë³€ê²½ ëœë‹¤ë¼ê³  í•˜ë©´ ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜ì •í•´ì•¼í•©ë‹ˆë‹¤.

## 3ë‹¨ê³„: ë¶ˆë³€ ê°ì²´ë¡œ ì„¤ê³„í•´ì„œ ëª…í™•í•˜ê²Œ
---
### JPA ì—”í‹°í‹°ì˜ ì œì•½ì‚¬í•­

ì—¬ê¸°ì„œ í¥ë¯¸ë¡œìš´ ì œì•½ì´ í•˜ë‚˜ ìˆìŠµë‹ˆë‹¤.

**JPA ì—”í‹°í‹°ëŠ” `final` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.**

Hibernateê°€ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ì„œë¸Œí´ë˜ì‹±ì„ í•„ìš”ë¡œ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ JPA ì—”í‹°í‹°ëŠ” ì–¸ì œë“  ìƒíƒœê°€ ë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ê²Œ ë­˜ ì˜ë¯¸í• ê¹Œìš”? ì½”ë“œë¥¼ ë´…ì‹œë‹¤:

```java
@Entity
public class Order {
    private BigDecimal totalAmount;

    // ë¬¸ì œ: ì´ ë©”ì„œë“œê°€ ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ”ì§€ ëª…í™•í•˜ì§€ ì•ŠìŒ
    public void applyDiscount(BigDecimal discountPercent) {
        totalAmount = totalAmount.multiply(BigDecimal.ONE.subtract(discountPercent));
    }

    // ë˜ëŠ” ì¡°íšŒì¸ ì¤„ ì•Œì•˜ëŠ”ë° ìƒíƒœë„ ë³€ê²½?
    public boolean discountApply(BigDecimal discountPercent) {
        if (totalAmount.compareTo(BigDecimal.ZERO) <= 0) {
            return false;  // ì¡°íšŒì¸ê°€?
        }
        totalAmount = totalAmount.multiply(BigDecimal.ONE.subtract(discountPercent));  // ëª…ë ¹?
        return true;
    }
}
```

**ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ê°œë°œìëŠ” í˜¼ë€ìŠ¤ëŸ½ìŠµë‹ˆë‹¤:**
- `applyDiscount()`ëŠ” ë©”ì„œë“œ ì´ë¦„ë§Œìœ¼ë¡œëŠ” ìƒíƒœë¥¼ ë³€ê²½í•˜ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ
- `discountApply()`ë¥¼ ë³´ë©´ ì¡°íšŒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ì‹¤ì œë¡œëŠ” ìƒíƒœë¥¼ ë³€ê²½í•¨

ì´ë¥¼ **CQS ì›ì¹™ ìœ„ë°˜**ì´ë¼ í•©ë‹ˆë‹¤. (Command-Query Separation)

### ë„ë©”ì¸ ê°ì²´ëŠ” ë¶ˆë³€ìœ¼ë¡œ ì„¤ê³„

ë„ë©”ì¸ ê°ì²´ëŠ” ë‹¤ë¦…ë‹ˆë‹¤. **`final` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ì„œ ë¶ˆë³€ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:**
```java
public class Order {
    private final Long id;
    private final String orderNumber;
    private final BigDecimal totalAmount;
    private final int quantity;
    private final LocalDateTime createdAt;

    public Order(Long id, String orderNumber, BigDecimal totalAmount, int quantity) {
        this.id = id;
        this.orderNumber = orderNumber;
        this.totalAmount = totalAmount;
        this.quantity = quantity;
        this.createdAt = LocalDateTime.now();
    }

    public Order applyDiscount(BigDecimal discountPercent) {
        if (totalAmount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("í• ì¸í•  ìˆ˜ ì—†ëŠ” ì£¼ë¬¸ì…ë‹ˆë‹¤");
        }

        BigDecimal discountedAmount = totalAmount.multiply(
            BigDecimal.ONE.subtract(discountPercent)
        );
        return new Order(this.id, this.orderNumber, discountedAmount, this.quantity);
    }

    public boolean canApplyDiscount(BigDecimal discountPercent) {
        return totalAmount.compareTo(BigDecimal.ZERO) > 0
            && discountPercent.compareTo(BigDecimal.ZERO) > 0
            && discountPercent.compareTo(BigDecimal.ONE) < 0;
    }

    public BigDecimal getTotalAmount() { return totalAmount; }
    public String getOrderNumber() { return orderNumber; }
}
```

final í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ë¶ˆë³€ ê°ì²´ê°€ ë˜ê³ , CQS ì›ì¹™ì„ ëª…í™•í•˜ê²Œ ì§€í‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ì¡°íšŒ(Query)**: `canApplyDiscount()` - í• ì¸ ê°€ëŠ¥ ì—¬ë¶€ë§Œ í™•ì¸í•˜ê³  ìƒíƒœëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ
- **ëª…ë ¹(Command)**: `applyDiscount()` - ìƒˆë¡œìš´ Order ê°ì²´ë¥¼ ë°˜í™˜

ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œëŠ” ì´ë¥¼ ëª…í™•í•˜ê²Œ êµ¬ë¶„í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤:

```java
@Service
public class OrderService {
    private final OrderRepository orderRepository;

    public Order applyDiscount(Long orderId, BigDecimal discountPercent) {
        Order order = orderRepository.findById(orderId);

        // 1ë‹¨ê³„: ì¡°íšŒ - í• ì¸ì„ ì ìš©í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸
        if (!order.canApplyDiscount(discountPercent)) {
            throw new InvalidDiscountException("í• ì¸ì„ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤");
        }

        // 2ë‹¨ê³„: ëª…ë ¹ - ìƒˆë¡œìš´ Order ê°ì²´ ìƒì„± (ì›ë³¸ì€ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
        Order discountedOrder = order.applyDiscount(discountPercent);

        // 3ë‹¨ê³„: ì €ì¥
        return orderRepository.save(discountedOrder);
    }
}
```

**`final` í‚¤ì›Œë“œê°€ ë§Œë“œëŠ” ëª…í™•ì„±:**

```java
// ì¡°íšŒë§Œ í•¨ - ìƒíƒœ ë³€ê²½ ì—†ìŒ
public boolean canApplyDiscount(BigDecimal discountPercent) {
    return totalAmount.compareTo(BigDecimal.ZERO) > 0
        && discountPercent.compareTo(BigDecimal.ZERO) > 0;
}

// ëª…ë ¹ - ìƒˆë¡œìš´ ê°ì²´ ë°˜í™˜ (ì›ë³¸ì€ ë³€ê²½ ì•ˆ ë¨)
public Order applyDiscount(BigDecimal discountPercent) {
    if (!canApplyDiscount(discountPercent)) {
        throw new InvalidDiscountException("í• ì¸ ë¶ˆê°€");
    }
    BigDecimal discountedAmount = totalAmount.multiply(
        BigDecimal.ONE.subtract(discountPercent)
    );
    return new Order(this.id, this.orderNumber, discountedAmount);
}
```

ì´ì œ ëª…í™•í•©ë‹ˆë‹¤:
- **ì¡°íšŒ(`canApplyDiscount`)** â†’ boolean ë°˜í™˜, ìƒíƒœ ë³€ê²½ ì—†ìŒ
- **ëª…ë ¹(`applyDiscount`)** â†’ ìƒˆë¡œìš´ Order ê°ì²´ ë°˜í™˜, ì›ë³¸ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

ê°œë°œìê°€ ì½”ë“œë¥¼ ì½ì„ ë•Œ **ë©”ì„œë“œ ì´ë¦„ê³¼ ë°˜í™˜ íƒ€ì…ë§Œìœ¼ë¡œ ì˜ë„ê°€ ëª…í™•**í•´ì§‘ë‹ˆë‹¤. ì´ê²ƒì´ **CQS ì›ì¹™**ì˜ í˜ì…ë‹ˆë‹¤.

`final` í‚¤ì›Œë“œëŠ” ë‹¨ìˆœí•œ ì œì•½ì´ ì•„ë‹ˆë¼, **ì•„í‚¤í…ì²˜ì  ëª…í™•ì„±**ì„ ê°•ì œí•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.


# ë©€í‹°ëª¨ë“ˆ: ì•„í‚¤í…ì²˜ë¥¼ ì½”ë“œë¡œ ê°•ì œ
---
ì§€ê¸ˆê¹Œì§€ëŠ” **ê°œë…ê³¼ íŒ¨í„´**ìœ¼ë¡œ ì˜ì¡´ì„±ì„ ê´€ë¦¬í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ **ì‚¬ëŒì€ ì‹¤ìˆ˜**í•©ë‹ˆë‹¤. ëˆ„êµ°ê°€ ê·œì¹™ì„ ë¬´ì‹œí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

ë” ê°•ë ¥í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤: **ë©€í‹°ëª¨ë“ˆ êµ¬ì¡°**

ì´ ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´, **ì»´íŒŒì¼ íƒ€ì„ì— ì•„í‚¤í…ì²˜ ì˜ì¡´ì„±ì´ ìë™ìœ¼ë¡œ ê°•ì œ**ë©ë‹ˆë‹¤. IDEê°€ ë¹¨ê°„ ì¤„ì„ ê·¸ìœ¼ë‹ˆê¹Œìš”.

## ëª¨ë“ˆ êµ¬ì¡°

í”„ë¡œì íŠ¸ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë¶„ë¦¬í•©ë‹ˆë‹¤:

```
order-service/
â”œâ”€â”€ order-domain          (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
â”œâ”€â”€ order-service         (Use Case)
â”œâ”€â”€ order-mariadb         (ë°ì´í„° ì ‘ê·¼)
â””â”€â”€ order-application     (API ì—”ë“œí¬ì¸íŠ¸)
```

ê° ëª¨ë“ˆì˜ ì˜ì¡´ì„±ì€ ì´ë ‡ê²Œ ì„¤ì •í•©ë‹ˆë‹¤:

```gradle
// order-application (ë§¨ ìœ„)
dependencies {
    implementation project(':order-service')
}

// order-service (ì¤‘ê°„)
dependencies {
    implementation project(':order-domain')
    runtimeOnly project(':order-mariadb')  // â† ì—¬ê¸°ê°€ í•µì‹¬!
}

// order-mariadb (ì•„ë˜)
dependencies {
    implementation project(':order-domain')
}

// order-domain (ë§¨ ì•„ë˜ - ì™¸ë¶€ ì˜ì¡´ì„± ì—†ìŒ)
dependencies {
    // í”„ë ˆì„ì›Œí¬ ì˜ì¡´ì„± ì—†ìŒ
}
```

## runtimeOnlyì˜ ë§ˆë²•

**`runtimeOnly`ëŠ” ìƒê°ë³´ë‹¤ ê°•ë ¥í•©ë‹ˆë‹¤.**

ì¼ë°˜ì ì¸ `implementation`:
```gradle
implementation project(':order-mariadb')
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´ order-mariadbì˜ ëª¨ë“  í´ë˜ìŠ¤ì— ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ `runtimeOnly`:
```gradle
runtimeOnly project(':order-mariadb')
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´:
- **ì»´íŒŒì¼ íƒ€ì„**: order-mariadbì˜ í´ë˜ìŠ¤ë¥¼ importí•  ìˆ˜ ì—†ìŒ (IDEê°€ ë¹¨ê°„ ì¤„)
- **ëŸ°íƒ€ì„**: Springì´ ìë™ìœ¼ë¡œ êµ¬í˜„ì²´ë¥¼ ì°¾ì•„ ì£¼ì…í•¨

## ê°•ì œë˜ëŠ” ì•„í‚¤í…ì²˜

ì´ê²Œ ì–´ë–¤ íš¨ê³¼ë¥¼ ë§Œë“¤ê¹Œìš”? ì˜ˆì‹œë¥¼ ë´…ì‹œë‹¤.

ëˆ„êµ°ê°€ êµ¬í˜„ì²´ì— ì§ì ‘ ì˜ì¡´í•˜ë ¤ê³  ì‹œë„í•©ë‹ˆë‹¤:

```java
// âŒ ì»´íŒŒì¼ ì—ëŸ¬ ë°œìƒ
@Service
public class OrderService {
    private final OrderRepositoryImpl impl;  // ë¹¨ê°„ ì¤„!

    public OrderService(OrderRepositoryImpl impl) {
        this.impl = impl;
    }
}
```

**IDEê°€ ì¦‰ì‹œ ë¹¨ê°„ ì¤„ì„ ê·¸ì–´ì¤ë‹ˆë‹¤.** OrderRepositoryImplì€ importí•  ìˆ˜ ì—†ìœ¼ë‹ˆê¹Œìš”. (runtimeOnly ì˜ì¡´ì„±)

ê°œë°œìëŠ” **ì–´ì©” ìˆ˜ ì—†ì´** ì¸í„°í˜ì´ìŠ¤ë¡œ ë³€ê²½í•  ìˆ˜ë°–ì— ì—†ìŠµë‹ˆë‹¤:

```java
// âœ… ì»´íŒŒì¼ ì„±ê³µ
@Service
public class OrderService {
    private final OrderRepository repository;  // ì¸í„°í˜ì´ìŠ¤ë§Œ ê°€ëŠ¥

    public OrderService(OrderRepository repository) {
        this.repository = repository;
    }
}
```

ì´ê²Œ ë°”ë¡œ **ë©€í‹°ëª¨ë“ˆì˜ ê°•ë ¥í•¨**ì…ë‹ˆë‹¤. íŒ€ ê·œì¹™ì— ì˜ì¡´í•˜ì§€ ì•Šê³ , **ì•„í‚¤í…ì²˜ë¥¼ ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì‹¤ì œ êµ¬í˜„ ì˜ˆì‹œ

### 1. order-domain ëª¨ë“ˆ (ë„ë©”ì¸)

```java
// ë„ë©”ì¸ ê°ì²´ (í”„ë ˆì„ì›Œí¬ì— ë¬´ê´€)
public class Order {
    private final Long id;
    private final String orderNumber;
    private final BigDecimal originalAmount;
    private final DiscountPolicy discountPolicy;
    private final LocalDateTime createdAt;

    public Order(Long id, String orderNumber, BigDecimal originalAmount, DiscountPolicy discountPolicy) {
        this.id = id;
        this.orderNumber = orderNumber;
        this.originalAmount = originalAmount;
        this.discountPolicy = discountPolicy;
        this.createdAt = LocalDateTime.now();
    }

    public BigDecimal getFinalAmount() {
        if (discountPolicy.isValid()) {
            BigDecimal discount = discountPolicy.calculateDiscountAmount(originalAmount);
            return originalAmount.subtract(discount);
        }
        return originalAmount;
    }

    public String getOrderNumber() { return orderNumber; }
    public BigDecimal getOriginalAmount() { return originalAmount; }
}

public interface OrderRepository {
    Order save(Order order);
    Order findById(Long id);
}

```

### 2. order-service ëª¨ë“ˆ (ì„œë¹„ìŠ¤)

```java
// ì„œë¹„ìŠ¤ëŠ” ë„ë©”ì¸ê³¼ ì¸í„°í˜ì´ìŠ¤ì—ë§Œ ì˜ì¡´
@Service
public class OrderService {
    private final OrderRepository orderRepository;
    private final DiscountPolicyRepository discountPolicyRepository;

    public OrderService(OrderRepository orderRepository, DiscountPolicyRepository discountPolicyRepository) {
        this.orderRepository = orderRepository;
        this.discountPolicyRepository = discountPolicyRepository;
    }

    public Order createOrder(String orderNumber, BigDecimal amount) {
        Order order = new Order(UUID.randomUUID(), orderNumber, amount);
        return orderRepository.save(order);
    }

    public Order getOrder(Long orderId) {
        return orderRepository.findById(orderId);
    }

    // íŠ¹ì • ì£¼ë¬¸ì˜ í• ì¸ ì •ì±…ë“¤ì„ ì¡°íšŒ
    public List<DiscountPolicy> getDiscountPolicies(Long orderId) {
        return discountPolicyRepository.findByOrderId(orderId);
    }

    // ì´ í• ì¸ì•¡ ê³„ì‚°
    public BigDecimal calculateTotalDiscount(Long orderId, BigDecimal originalAmount) {
        List<DiscountPolicy> policies = discountPolicyRepository.findByOrderId(orderId);
        return policies.stream()
            .filter(DiscountPolicy::isValid)
            .map(policy -> policy.calculateDiscountAmount(originalAmount))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}
```

ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì€ `OrderRepository`ì™€ `DiscountPolicyRepository` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì£¼ì…ë°›ì§€ë§Œ, ì‹¤ì œ êµ¬í˜„ì²´ê°€ ë­”ì§€ **ì•Œ í•„ìš”ê°€ ì—†ë‹¤**ëŠ” ê²ƒì…ë‹ˆë‹¤. order-persistence ëª¨ë“ˆì˜ ì¡´ì¬ ìì²´ë¥¼ ëª¨ë¥´ê³ , ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ì„œë§Œ ë°ì´í„°ì— ì ‘ê·¼í•©ë‹ˆë‹¤.

### 3. order-mariadb ëª¨ë“ˆ (ì˜ì†ì„± ë ˆì´ì–´)

```java
// JPA ì—”í‹°í‹° (ì˜ì†ì„± ë ˆì´ì–´ì—ë§Œ ì¡´ì¬)
@Entity
@Table(name = "orders")
@Getter
@Setter
public class OrderEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String orderNumber;
    private BigDecimal originalAmount;
    private LocalDateTime createdAt;
}

// ë„ë©”ì¸ ë¦¬í¬ì§€í† ë¦¬ì˜ êµ¬í˜„ì²´ (spring-data-jpa)
@Repository
public class OrderRepositoryImpl implements OrderRepository {
    private final OrderJpaRepository jpaRepository;

    public OrderRepositoryImpl(OrderJpaRepository jpaRepository) {
        this.jpaRepository = jpaRepository;
    }

    @Override
    public Order save(Order order) {
        OrderEntity entity = new OrderEntity();
        entity.setOrderNumber(order.getOrderNumber());
        entity.setOriginalAmount(order.getOriginalAmount());
        entity.setCreatedAt(LocalDateTime.now());

        OrderEntity saved = jpaRepository.save(entity);
        return new Order(saved.getId(), saved.getOrderNumber(), saved.getOriginalAmount());
    }

    @Override
    public Order findById(Long id) {
        return jpaRepository.findById(id)
            .map(entity -> new Order(entity.getId(), entity.getOrderNumber(), entity.getOriginalAmount()))
            .orElseThrow();
    }
}

@Repository
public interface OrderJpaRepository extends JpaRepository<OrderEntity, Long> {
}

```

### 4. order-application ëª¨ë“ˆ (í”„ë ˆì  í…Œì´ì…˜)

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    private final OrderService orderService;

    public OrderController(OrderService orderService) {
        this.orderService = orderService;
    }

    @PostMapping
    public OrderResponse createOrder(@RequestBody CreateOrderRequest request) {
        Order order = orderService.createOrder(request.getOrderNumber(), request.getAmount());
        return OrderResponse.from(order);
    }

    @GetMapping("/{orderId}")
    public OrderResponse getOrder(@PathVariable Long orderId) {
        Order order = orderService.getOrder(orderId);
        return OrderResponse.from(order);
    }
}
```

## ì˜ì¡´ì„± êµ¬ì¡° ì‹œê°í™”
---

![ë©€í‹°ëª¨ë“ˆ ì•„í‚¤í…ì³](/assets/images/posts/ë©€í‹°ëª¨ë“ˆ%20ì•„í‚¤í…ì³2.png)